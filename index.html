<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <title>CloverPit Companion</title>
  <link rel="manifest" href="manifest.webmanifest?v=2025-10-03-03">
  <meta name="theme-color" content="#0d1117">
  <link rel="stylesheet" href="style.css?v=2025-10-03-03">
  <script>(function(){if(window.__cpit_boot)return;window.__cpit_boot={ok:false,errs:[]};function el(){var e=document.getElementById('cpit_err_badge');if(e)return e;e=document.createElement('div');e.id='cpit_err_badge';e.innerHTML='<div class="t">‚ö†Ô∏è Startproblem</div><div class="m"></div><button id="cpit_copy">Details kopieren</button>';document.documentElement.appendChild(e);return e}function msg(x){try{return typeof x==='string'?x:(x&&x.stack)||x.message||JSON.stringify(x)}catch(e){return'Startfehler'}}function show(m){var e=el();e.querySelector('.m').textContent=m;document.getElementById('cpit_copy').onclick=function(){navigator.clipboard.writeText(window.__cpit_boot.errs.join('\n'))}}function rep(k,err){var m='['+k+'] '+msg(err);window.__cpit_boot.errs.push(m);show(m);}window.addEventListener('error',function(e){rep('error',e.error||e.message||e)});window.addEventListener('unhandledrejection',function(e){rep('unhandledrejection',e.reason||e)});})();</script>
</head>
<body>
  <header class="hdr">
    <div class="wrap row space">
      <div class="row gap">
        <img src="icons/app-192.png" alt="Logo" class="logo">
        <h1>üçÄ CloverPit Companion</h1>
      </div>
      <div class="row gap">
        <div id="versionBadge" class="ver-badge" aria-live="polite"></div>
        <button id="exportBtn">Export</button>
        <button id="importBtn">Import</button>
        <input type="file" id="fileInput" accept="application/json" hidden>
        <button id="resetBtn">Reset</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel pad">
      <h2>Bestand</h2>
      <div class="row gap">
        <div><label for="coins">M√ºnzen</label><input type="number" id="coins" min="0" step="1" inputmode="numeric"/></div>
        <div><label for="tickets">Tickets</label><input type="number" id="tickets" min="0" step="1" inputmode="numeric"/></div>
      </div>

      <div class="active-bar" id="activeBar" aria-live="polite"></div>
      <div class="summary-box" id="summaryBox">Keine aktiven Gl√ºcksbringer.</div>
    </section>

    <section class="panel pad">
      <h2>Gl√ºcksbringer</h2>
      <div id="grid" class="grid" aria-live="polite"></div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  var VERSION='2025-10-03-03';
  function bust(u){return u+(u.indexOf('?')>=0?'&':'?')+'v='+VERSION;}

  if('serviceWorker' in navigator){navigator.serviceWorker.register('./service-worker.js',{updateViaCache:'none'}).then(function(reg){document.addEventListener('visibilitychange',function(){if(document.visibilityState==='visible') reg.update();});setInterval(function(){reg.update();},30*60*1000);});}

  fetch(bust('version.json'),{cache:'no-store'}).then(function(r){return r.json()}).then(function(d){var el=document.getElementById('versionBadge');el.textContent='v '+((d&&d.version)||'');});

  var CHARMS=[];
  fetch(bust('charms.json')).then(function(r){return r.json()}).then(function(d){CHARMS=d||[]; renderGrid(); updateSummary();});

  var store={load:function(){try{return JSON.parse(localStorage.getItem('cpit')||'{}');}catch(e){return {};}},
             save:function(x){try{localStorage.setItem('cpit',JSON.stringify(x));}catch(e){}}};
  var state=(function(){var base={coins:0,tickets:0,owned:{}};var s=store.load();for(var k in s)base[k]=s[k];return base;})();

  var coinsEl=document.getElementById('coins'), ticketsEl=document.getElementById('tickets');
  coinsEl.value=state.coins; ticketsEl.value=state.tickets;
  coinsEl.addEventListener('input',function(e){state.coins=(+e.target.value)||0; sync();});
  ticketsEl.addEventListener('input',function(e){state.tickets=(+e.target.value)||0; sync();});

  document.getElementById('exportBtn').addEventListener('click', function(){ var blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='cloverpit-companion.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showToast('Export abgeschlossen'); });
  document.getElementById('importBtn').addEventListener('click', function(){ document.getElementById('fileInput').click(); });
  document.getElementById('fileInput').addEventListener('change', function(e){ var f=e.target.files && e.target.files[0]; if(!f) return; var r=new FileReader(); r.onload=function(){ try{ var data=JSON.parse(r.result); for(var k in data) state[k]=data[k]; coinsEl.value=state.coins; ticketsEl.value=state.tickets; renderGrid(); updateSummary(); sync(); showToast('Import erfolgreich'); }catch(_e){ showToast('Ung√ºltige JSON-Datei'); } }; r.readAsText(f); });
  document.getElementById('resetBtn').addEventListener('click', function(){ if(confirm('Alles zur√ºcksetzen?')){ localStorage.removeItem('cpit'); location.reload(); }});

  function $(s){return document.querySelector(s);}
  var grid=$('#grid'), activeBar=$('#activeBar'), summaryBox=$('#summaryBox');

  function renderGrid(){ grid.innerHTML=''; for(var i=0;i<CHARMS.length;i++){ var c=CHARMS[i]; var t=document.createElement('button'); t.type='button'; t.className='tile'+(state.owned[c.id]?' active':''); t.setAttribute('aria-pressed', state.owned[c.id]?'true':'false'); (function(id){ t.addEventListener('click', function(){ state.owned[id]=!state.owned[id]; renderGrid(); updateSummary(); sync(); showToast(state.owned[id]?'Aktiviert':'Deaktiviert'); }); })(c.id); var nm=document.createElement('div'); nm.className='name'; nm.textContent=c.name; var eff=document.createElement('div'); eff.className='effect'; eff.textContent=c.effect; var meta=document.createElement('div'); meta.className='meta'; var b1=document.createElement('span'); b1.className='badge'; b1.textContent='üéüÔ∏è '+c.tickets; var b2=document.createElement('span'); b2.className='badge'; b2.textContent=c.rarity; var b3=document.createElement('span'); b3.className='badge own'; b3.textContent=state.owned[c.id]?'aktiv':'tippen zum Aktivieren'; meta.appendChild(b1); meta.appendChild(b2); meta.appendChild(b3); t.appendChild(nm); t.appendChild(eff); t.appendChild(meta); grid.appendChild(t); } updateActiveBar(); }

  function updateActiveBar(){ activeBar.innerHTML=''; for(var i=0;i<CHARMS.length;i++){var c=CHARMS[i]; if(state.owned[c.id]){ var chip=document.createElement('div'); chip.className='active-chip'; chip.textContent=c.name; activeBar.appendChild(chip);} }}

  function aggregateMods(){ var sum={}; for(var i=0;i<CHARMS.length;i++){ var c=CHARMS[i]; if(!state.owned[c.id]) continue; var m=c.mods||{}; for(var k in m){ var v=m[k]; if(v==null) continue; if(typeof v==='number'){ sum[k]=(sum[k]||0)+v; } else if(typeof v==='boolean'){ sum[k]=(sum[k]||0)+(v?1:0); } else if(typeof v==='object'){ if(!sum[k]) sum[k]={}; for(var sub in v){ sum[k][sub]=(sum[k][sub]||0)+v[sub]; } } } } return sum; }

  function humanize(sum){ var parts=[]; if(sum.energy_end) parts.push('Energy am Deadline‚ÄëEnde: +'+sum.energy_end); if(sum.spins_per_round) parts.push('Spins pro Runde: +'+sum.spins_per_round); if(sum.luck_random) parts.push('Luck (zuf√§llig): +'+sum.luck_random); if(sum.luck_next_spin) parts.push('Luck n√§chster Spin: +'+sum.luck_next_spin); if(sum.luck_last_spin) parts.push('Luck letzter Spin: +'+sum.luck_last_spin); if(sum.interest_pct) parts.push('Zins: +'+sum.interest_pct+'%'); if(sum.pattern_multiplier) parts.push('Muster-Multiplier √ó'+sum.pattern_multiplier); if(sum.red_button_bias){ var sub=sum.red_button_bias, arr=[]; for(var k in sub) arr.push(k+' +'+sub[k]); parts.push('Red‚ÄëButton Bias: '+arr.join(', ')); } if(sum.golden_bias){ var sub2=sum.golden_bias, arr2=[]; for(var g in sub2) arr2.push(g+' +'+sub2[g]+'%'); parts.push('Golden‚ÄëBias: '+arr2.join(', ')); } if(!parts.length) parts.push('Keine aggregierten Effekte.'); return parts.join(' ¬∑ '); }

  function updateSummary(){ var sum=aggregateMods(); var ownedCount=0; for(var i=0;i<CHARMS.length;i++) if(state.owned[CHARMS[i].id]) ownedCount++; var header=ownedCount+'/'+CHARMS.length+' aktiv ¬∑ Tickets: '+state.tickets+' ¬∑ M√ºnzen: '+state.coins; summaryBox.textContent=header+' ‚Äî '+humanize(sum); }

  function sync(){ store.save(state); }

  function showToast(msg){ var el=document.getElementById('toast'); if(!el) return; el.textContent=msg; el.classList.remove('show'); void el.offsetWidth; el.classList.add('show'); setTimeout(function(){ el.classList.remove('show'); }, 1300); }
})();
</script>

</body>
</html>
