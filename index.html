<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CloverPit Companion</title>
  <link rel="manifest" href="manifest.webmanifest?v=2025-10-02-10">
  <link rel="stylesheet" href="style.css?v=2025-10-02-10">
  <script>
(function(){ 
  if (window.__cpit_boot) return;
  window.__cpit_boot = { ok:false, errs:[] };
  function ensureBadge(){ 
    var el=document.getElementById('cpit_err_badge'); 
    if(el) return el;
    el=document.createElement('div'); el.id='cpit_err_badge'; el.setAttribute('role','status'); el.setAttribute('aria-live','assertive');
    el.innerHTML='<div class="t">‚ö†Ô∏è Startproblem</div><div class="m"></div><div class="row"><button id="cpit_copy">Details kopieren</button><span class="small" id="cpit_count"></span></div>';
    document.documentElement.appendChild(el); 
    return el;
  }
  function textOf(err){ 
    try{ 
      if(!err) return 'Unbekannter Fehler';
      if(typeof err==='string') return err;
      if(err.stack) return String(err.stack);
      if(err.message) return String(err.message);
      return JSON.stringify(err);
    }catch(e){ return 'Unbekannter Fehler'; }
  }
  function updateBadge(msg){
    var el=ensureBadge();
    var m=el.querySelector('.m'); var c=el.querySelector('#cpit_count');
    m.textContent = msg.slice(0,600);
    c.textContent = '('+window.__cpit_boot.errs.length+' Fehler)';
    var copyBtn = el.querySelector('#cpit_copy');
    copyBtn.onclick = function(){
      try{ 
        var all = window.__cpit_boot.errs.join('\n');
        navigator.clipboard.writeText(all).then(()=>{copyBtn.textContent='Kopiert'; setTimeout(()=>copyBtn.textContent='Details kopieren',1500);});
      }catch(e){ alert('Kopieren nicht m√∂glich'); }
    };
  }
  function report(kind, err){
    var msg = '['+kind+'] '+ textOf(err);
    window.__cpit_boot.errs.push(msg);
    updateBadge(msg);
    try{ console.warn('[CloverPit boot]', kind, err); }catch(_ ){}
  }
  window.addEventListener('error', function(e){ report('error', e.error||e.message||e); });
  window.addEventListener('unhandledrejection', function(e){ report('unhandledrejection', e.reason||e); });
})();
</script>
</head>
<body>
  <header class="hdr">
    <div class="wrap row space">
      <div class="row gap"><img class="logo" src="icons/app-192.png" alt=""><h1>üçÄ CloverPit Companion</h1></div>
      <div class="row gap"><div id="versionBadge" class="ver-badge" hidden></div></div>
    </div>
  </header>
  <main class="wrap">
    <p>Fehlerausgabe ist jetzt **explizit** sichtbar (auch mobil). Teste den Button:</p>
    <button id="testError">Testfehler</button>
  </main>
  <script type="module">
    const VERSION = "2025-10-02-10";
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js', { updateViaCache: 'none' });
      navigator.serviceWorker.addEventListener('controllerchange', ()=>location.reload());
    }
    fetch('./version.json?v='+VERSION, {cache:'no-store'}).then(r=>r.json()).then(d=>{
      const el=document.getElementById('versionBadge'); if(el){ el.textContent='v '+(d.version||''); el.hidden=false; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 2000); }
    });
    document.getElementById('testError')?.addEventListener('click', ()=>{ Promise.reject(new Error('Absichtlicher Testfehler f√ºr die Badge-Ausgabe')); });
  </script>
</body>
</html>
